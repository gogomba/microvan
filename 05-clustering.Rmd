# Clustering
***
```{r}
EFA_feature = EFA_with_score %>%
  dplyr::select(PA1, PA2,PA4)

# Run a cluster analysis on a distance matrix and using the Ward method
c<- hclust(dist(EFA_feature), method="ward.D2") 

# Dendrogram 
library(dendextend)
plot(set(as.dendrogram(c),  
         "branches_k_color", # to highlight the cluster solution with a color
         k = 3),
     ylab = "Distance",
     main = "Dendrogram",
     cex = 0.2)

set.seed(42)
EFA_kmeans <- kmeans(EFA_feature , centers = 3)
EFA_kmeans

# factor plot 
fviz_cluster(EFA_kmeans, 
             data = EFA_feature) + 
  theme_bw()

```

## Interpretation of the results
### Histogram
```{r,echo=FALSE,message=FALSE}

vars_cluster <- cbind(vars, cluster= EFA_kmeans$cluster) %>%
  as.data.frame()

df = vars_cluster %>%
  gather(variable, value, -cluster)  %>%
  as.data.frame()

# factorize cluster 
df$cluster <- factor(df$cluster)

# plot
vars_cluster_hist = ggplot(df, aes(value, 
                     fill = cluster, 
                     color = cluster)) +
  geom_histogram(alpha = 0.5, position = "identity")  +
  facet_wrap( ~ variable, scales = "free",ncol = 6)  +
  theme_economist_white() 

vars_cluster_hist_path = file.path(plotDir, "vars_cluster_hist.png")

ggsave(
  filename = vars_cluster_hist_path,
  plot = vars_cluster_hist,
  width = 3000,
  height = 3000,
  units = "px"
)
```
```{r echo=FALSE, fig.cap="", out.width = '100%'}
knitr::include_graphics(vars_cluster_hist_path)
```



```{r}
# Average for each cluster with one step


vars_cluster_agg = aggregate(vars_cluster[, 2:31],
          by = list(cluster = EFA_kmeans$cluster), 
          FUN = mean)
# reshape
df <- vars_cluster_agg %>% 
  gather(variable, value, -cluster)  # to transfrom from wide to long format
 
```

### Heatmap Table
```{r}
library(gt)
library(scales)

# reshpae, long to wide (cluster )
df_wider = df%>%
  dplyr::mutate(cluster = paste0("Cluster", cluster)) %>%
  dplyr::mutate(., across(where(is.numeric), round, 2)) %>%
  spread(., key=cluster, value =value)

# cluster columns
clusterCols = c("Cluster1", "Cluster2", "Cluster3")

# color
colfunc <- colorRampPalette(c("darkblue", "lightgrey"))

# DT table 
DT::datatable(bytopic, options = list(pageLength = 15)) %>%
  formatStyle("Cluster1",
              backgroundColor = styleEqual(sort(unique(bytopic$Cluster1),
                                                decreasing = TRUE),
                                           colfunc(length(
                                             unique(bytopic$Cluster1)
                                           )))) %>%
  formatStyle("Cluster2",
              backgroundColor = styleEqual(sort(unique(bytopic$Cluster2),
                                                decreasing = TRUE),
                                           colfunc(length(
                                             unique(bytopic$Cluster2)
                                           )))) %>%
  formatStyle("Cluster3",
              backgroundColor = styleEqual(sort(unique(bytopic$Cluster3),
                                                decreasing = TRUE),
                                           colfunc(length(
                                             unique(bytopic$Cluster3)
                                           )))) %>%
  formatStyle(clusterCols, color = "white")
```

```{r include=F }
df %>% # to reverse the order of car makes' names on the plot
  mutate(variable = fct_rev(factor(variable)))  %>%
  ggplot(aes(x = factor(cluster), y = variable)) +
  geom_tile(aes(fill = round(value, digits = 2))) +
  geom_text(aes(label = round(value, digits = 2)), color="white") +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  scale_fill_gradient("Average\n value", low = "lightgrey", high = "darkblue") +
  theme_minimal() +
  labs(title = "Average preferences in each cluster",
       x = "Cluster",
       y = " ") + 
  theme(legend.position="right", 
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.ticks = element_blank()) 


# show DT table in rMD
DT::datatable(df_wider )%>%
  formatStyle(clusterCols,
   background = styleColorBar(range(df_wider[clusterCols] ),color = styleInterval(cuts = 0, values = c("red","blue"))),
                                
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')

# show heatmap table
DT::datatable(df_wider )%>%
  formatStyle(clusterCols, 
               background =  styleInterval(0, c("lightgrey","darkblue")),
              color = "white")
```